<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>netstandard1.2</TargetFrameworks>
  </PropertyGroup>

  <ItemGroup>
    <GenerateSource Include="..\..\Data\source.psv"/>
    <None Include="@(GenerateSource)" />
  </ItemGroup>

  <UsingTask
    TaskName="PsvCodeGenerator"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <SourceFile ParameterType="Microsoft.Build.Framework.ITaskItem" Required="true" />
      <GeneratedFile ParameterType="System.String" Output="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
var psvData = System.IO.File.ReadAllText(SourceFile.GetMetadata("FullPath"));
GeneratedFile = "Banks.Generated.cs";
File.WriteAllText(GeneratedFile, "// autogenerated " + DateTime.Now + @"
namespace Swedishbankers.Bank.Data;

public static partial class Banks
{
    public static readonly string SourcePsv = @""
" + psvData.Trim() + @""";
}");
]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="GenerateCompile" AfterTargets="BeforeBuild" Inputs="@(GenerateSource)" Outputs="$(RootFolder)\Banks.Generated.cs">
    <PsvCodeGenerator SourceFile="@(GenerateSource)">
      <Output TaskParameter="GeneratedFile" PropertyName="PsvGeneratedFile" />
    </PsvCodeGenerator>
    <Message Text="Generated $(PsvGeneratedFile) from @(GenerateSource)" />
    <ItemGroup>
      <Compile Remove="$(PsvGeneratedFile)" />
      <Compile Include="$(PsvGeneratedFile)">
        <AutoGen>True</AutoGen>
        <DependentUpon>@(GenerateSource)</DependentUpon>
      </Compile>
    </ItemGroup>
  </Target>

  <Target Name="CleanGenerated" BeforeTargets="CoreClean">
    <ItemGroup>
      <FilesToDelete Include="*.Generated.cs"/>
    </ItemGroup>
    <Delete Files="@(FilesToDelete)" >
      <Output TaskParameter="DeletedFiles" ItemName="DeletedList"/>
    </Delete>
    <Message Text="Deleted files: '@(DeletedList)'"/>
  </Target>

</Project>
